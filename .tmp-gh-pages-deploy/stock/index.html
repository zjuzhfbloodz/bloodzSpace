<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zjuzhfbloodz.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="A股看盘 Demo        :root {       --bg: #0c1018;       --panel: #131a26;       --panel-soft: #1a2435;       --line: #24324a;       --text: #e8edf7;       --muted: #8ea0be;       --up: #ff5e5e;">
<meta property="og:type" content="website">
<meta property="og:title" content="Bloodz&#39;s Space">
<meta property="og:url" content="https://zjuzhfbloodz.github.io/stock/index.html">
<meta property="og:site_name" content="Bloodz&#39;s Space">
<meta property="og:description" content="A股看盘 Demo        :root {       --bg: #0c1018;       --panel: #131a26;       --panel-soft: #1a2435;       --line: #24324a;       --text: #e8edf7;       --muted: #8ea0be;       --up: #ff5e5e;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2026-02-23T11:44:30.015Z">
<meta property="article:modified_time" content="2026-02-23T11:35:33.525Z">
<meta property="article:author" content="Bloodz Zhao">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://zjuzhfbloodz.github.io/stock/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : false,
    lang   : 'zh-cn'
  };
</script>

  <title> | Bloodz's Space
</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bloodz's Space</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">日以记之，一期一会</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-compass fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-ideas">

    <a href="/ideas/" rel="section"><i class="fa fa-lightbulb fa-fw"></i>Ideas</a>

  </li>
        <li class="menu-item menu-item-pets">

    <a href="/pets/" rel="section"><i class="fa fa-paw fa-fw"></i>pets</a>

  </li>
        <li class="menu-item menu-item-blog">

    <a href="/blog/" rel="section"><i class="fa fa-book-open fa-fw"></i>blog</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
  
  

          <div class="content page posts-expand">
            

    
    
    
    <div class="post-block" lang="zh-cn">
      <header class="post-header">

<h1 class="post-title" itemprop="name headline">
</h1>

<div class="post-meta">
  

</div>

</header>

      
      
      
      <div class="post-body">
          <!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A股看盘 Demo</title>
  <style>
    :root {
      --bg: #0c1018;
      --panel: #131a26;
      --panel-soft: #1a2435;
      --line: #24324a;
      --text: #e8edf7;
      --muted: #8ea0be;
      --up: #ff5e5e;
      --down: #2bcf94;
      --accent: #5aa9ff;
      --warn: #ffb866;
      --danger: #ff7f7f;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% -20%, #1b2c48 0%, transparent 60%),
        radial-gradient(1000px 500px at 90% -30%, #223453 0%, transparent 60%),
        var(--bg);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 24px;
      display: grid;
      gap: 16px;
    }

    .card {
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0));
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .toolbar {
      padding: 14px;
      display: grid;
      gap: 12px;
    }

    .toolbar-top {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .search-wrap {
      display: flex;
      gap: 10px;
      flex: 1;
      min-width: 280px;
    }

    input[type="text"],
    select {
      background: var(--panel-soft);
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
    }

    input[type="text"] {
      flex: 1;
      min-width: 180px;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(90, 169, 255, 0.15);
    }

    .switch-wrap {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
      user-select: none;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    button {
      border: 0;
      border-radius: 12px;
      padding: 0 14px;
      height: 40px;
      background: linear-gradient(135deg, #2e8cff, #5ab1ff);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    button.secondary {
      background: var(--panel-soft);
      border: 1px solid var(--line);
      color: var(--text);
    }

    .toolbar-bottom {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      color: var(--muted);
      font-size: 13px;
    }

    .status-pill {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 12px;
      background: rgba(255, 255, 255, 0.03);
    }

    .status-realtime {
      color: var(--down);
      border-color: rgba(43, 207, 148, 0.45);
      background: rgba(43, 207, 148, 0.1);
    }

    .status-degraded {
      color: var(--warn);
      border-color: rgba(255, 184, 102, 0.45);
      background: rgba(255, 184, 102, 0.1);
    }

    .status-error {
      color: var(--danger);
      border-color: rgba(255, 127, 127, 0.45);
      background: rgba(255, 127, 127, 0.1);
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    .quote {
      padding: 16px;
      display: grid;
      gap: 14px;
    }

    .headline {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .symbol {
      font-size: 14px;
      color: var(--muted);
    }

    .price-row {
      display: flex;
      align-items: end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .latest {
      font-size: 40px;
      font-weight: 700;
      letter-spacing: 0.5px;
      line-height: 1;
    }

    .delta {
      font-size: 18px;
      font-weight: 600;
    }

    .up { color: var(--up); }
    .down { color: var(--down); }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .stat {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
    }

    .label {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }

    .value {
      font-size: 16px;
      font-variant-numeric: tabular-nums;
    }

    .chart-wrap {
      padding: 0 16px 16px;
    }

    .chart-box {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(24, 39, 63, 0.8), rgba(12, 16, 24, 0.9));
      padding: 10px;
    }

    canvas {
      width: 100%;
      height: 250px;
      display: block;
    }

    .watchlist {
      padding: 14px;
    }

    .watch-title {
      margin: 0 0 10px;
      font-size: 15px;
      color: var(--muted);
    }

    .watch-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.01);
    }

    .watch-item.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(90, 169, 255, 0.18) inset;
    }

    .watch-name {
      font-size: 13px;
      color: var(--muted);
    }

    .notice {
      font-size: 12px;
      color: var(--muted);
      padding: 0 16px 16px;
      line-height: 1.5;
    }

    .error-text {
      color: #ff9d9d;
      font-size: 12px;
      min-height: 16px;
      padding-left: 2px;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 560px) {
      .latest { font-size: 32px; }
      .delta { font-size: 16px; }
      canvas { height: 210px; }
      .search-wrap { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card toolbar">
      <div class="toolbar-top">
        <div class="search-wrap">
          <input id="symbolInput" type="text" placeholder="输入 sh600519 或 sz000001" value="sh600519" />
          <button id="searchBtn">查询</button>
          <button id="refreshBtn" class="secondary">立即刷新</button>
        </div>
      </div>

      <div class="toolbar-top">
        <label class="switch-wrap">数据模式
          <select id="dataMode">
            <option value="api" selected>实时API（默认）</option>
            <option value="mock">模拟数据</option>
          </select>
        </label>

        <label class="switch-wrap">
          <input id="autoRefresh" type="checkbox" checked />
          自动刷新
        </label>

        <label class="switch-wrap">刷新间隔
          <select id="refreshInterval">
            <option value="3">3 秒</option>
            <option value="5" selected>5 秒</option>
            <option value="10">10 秒</option>
            <option value="15">15 秒</option>
          </select>
        </label>
      </div>

      <div class="toolbar-bottom">
        <span id="dataSource">数据源：--</span>
        <span id="connectionStatus" class="status-pill">连接状态：--</span>
        <span id="lastUpdate">最后更新时间：--</span>
      </div>

      <div id="errorText" class="error-text"></div>
    </div>

    <div class="layout">
      <div class="card">
        <div class="quote">
          <div class="headline">
            <div>
              <div id="stockName">--</div>
              <div id="stockSymbol" class="symbol">--</div>
            </div>
          </div>

          <div class="price-row">
            <div id="latestPrice" class="latest">--</div>
            <div id="delta" class="delta">--</div>
          </div>

          <div class="stats">
            <div class="stat"><div class="label">今开</div><div id="open" class="value">--</div></div>
            <div class="stat"><div class="label">最高</div><div id="high" class="value">--</div></div>
            <div class="stat"><div class="label">最低</div><div id="low" class="value">--</div></div>
            <div class="stat"><div class="label">成交量</div><div id="volume" class="value">--</div></div>
            <div class="stat"><div class="label">成交额</div><div id="amount" class="value">--</div></div>
            <div class="stat"><div class="label">涨跌额</div><div id="change" class="value">--</div></div>
            <div class="stat"><div class="label">涨跌幅</div><div id="changePct" class="value">--</div></div>
            <div class="stat"><div class="label">状态</div><div id="status" class="value">--</div></div>
          </div>
        </div>

        <div class="chart-wrap">
          <div class="chart-box">
            <canvas id="minuteChart"></canvas>
          </div>
        </div>

        <div class="notice">说明：实时 API 模式会请求本地代理 <code>/api/quote?symbol=...</code>；若接口超时或报错将自动降级为模拟数据，页面保持可用。</div>
      </div>

      <div class="card watchlist">
        <h3 class="watch-title">自选股</h3>
        <div id="watchList"></div>
      </div>
    </div>
  </div>

  <script>
    const WATCH_STOCKS = [
      { code: 'sh600519', name: '贵州茅台' },
      { code: 'sz000001', name: '平安银行' },
      { code: 'sz300750', name: '宁德时代' },
      { code: 'sh601318', name: '中国平安' },
      { code: 'sh600036', name: '招商银行' },
      { code: 'sz002415', name: '海康威视' }
    ];

    const API_TIMEOUT_MS = 4500;
    const API_ENDPOINTS = ['/api/quote', 'http://127.0.0.1:8787/api/quote'];

    const state = {
      currentSymbol: 'sh600519',
      currentQuote: null,
      minuteSeries: [],
      refreshTimer: null,
      requestId: 0
    };

    const el = {
      symbolInput: document.getElementById('symbolInput'),
      searchBtn: document.getElementById('searchBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      dataMode: document.getElementById('dataMode'),
      autoRefresh: document.getElementById('autoRefresh'),
      refreshInterval: document.getElementById('refreshInterval'),
      watchList: document.getElementById('watchList'),
      errorText: document.getElementById('errorText'),
      dataSource: document.getElementById('dataSource'),
      connectionStatus: document.getElementById('connectionStatus'),
      lastUpdate: document.getElementById('lastUpdate'),
      stockName: document.getElementById('stockName'),
      stockSymbol: document.getElementById('stockSymbol'),
      latestPrice: document.getElementById('latestPrice'),
      delta: document.getElementById('delta'),
      open: document.getElementById('open'),
      high: document.getElementById('high'),
      low: document.getElementById('low'),
      volume: document.getElementById('volume'),
      amount: document.getElementById('amount'),
      change: document.getElementById('change'),
      changePct: document.getElementById('changePct'),
      status: document.getElementById('status'),
      canvas: document.getElementById('minuteChart')
    };

    const ctx = el.canvas.getContext('2d');

    function validateSymbol(raw) {
      return /^(sh|sz)\d{6}$/i.test(raw.trim());
    }

    function normalizeSymbol(raw) {
      return raw.trim().toLowerCase();
    }

    function formatNumber(value, digits = 2) {
      if (typeof value !== 'number' || Number.isNaN(value)) return '--';
      return value.toLocaleString('zh-CN', {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      });
    }

    function formatVolume(volume) {
      if (typeof volume !== 'number' || Number.isNaN(volume)) return '--';
      if (volume >= 1e8) return `${(volume / 1e8).toFixed(2)} 亿`;
      if (volume >= 1e4) return `${(volume / 1e4).toFixed(2)} 万`;
      return `${volume.toFixed(0)}`;
    }

    function formatAmount(amount) {
      if (typeof amount !== 'number' || Number.isNaN(amount)) return '--';
      if (amount >= 1e8) return `${(amount / 1e8).toFixed(2)} 亿元`;
      if (amount >= 1e4) return `${(amount / 1e4).toFixed(2)} 万元`;
      return `${amount.toFixed(0)} 元`;
    }

    function setError(msg = '') {
      el.errorText.textContent = msg;
    }

    function setTrendClass(target, value) {
      target.classList.remove('up', 'down');
      if (value > 0) target.classList.add('up');
      else if (value < 0) target.classList.add('down');
    }

    function setConnectionStatus(type, text) {
      el.connectionStatus.classList.remove('status-realtime', 'status-degraded', 'status-error');
      if (type === 'realtime') el.connectionStatus.classList.add('status-realtime');
      if (type === 'degraded') el.connectionStatus.classList.add('status-degraded');
      if (type === 'error') el.connectionStatus.classList.add('status-error');
      el.connectionStatus.textContent = `连接状态：${text}`;
    }

    function updateTimeLabel(date = new Date()) {
      const time = date.toLocaleTimeString('zh-CN', { hour12: false });
      el.lastUpdate.textContent = `最后更新时间：${time}`;
    }

    function renderQuote(quote) {
      state.currentQuote = quote;
      el.stockName.textContent = quote.name || '--';
      el.stockSymbol.textContent = quote.symbol ? quote.symbol.toUpperCase() : '--';
      el.latestPrice.textContent = formatNumber(quote.latest, 2);

      const deltaText = `${quote.change >= 0 ? '+' : ''}${formatNumber(quote.change, 2)} (${quote.changePct >= 0 ? '+' : ''}${formatNumber(quote.changePct, 2)}%)`;
      el.delta.textContent = deltaText;

      setTrendClass(el.latestPrice, quote.change);
      setTrendClass(el.delta, quote.change);

      el.open.textContent = formatNumber(quote.open, 2);
      el.high.textContent = formatNumber(quote.high, 2);
      el.low.textContent = formatNumber(quote.low, 2);
      el.volume.textContent = formatVolume(quote.volume);
      el.amount.textContent = formatAmount(quote.amount);
      el.change.textContent = `${quote.change >= 0 ? '+' : ''}${formatNumber(quote.change, 2)}`;
      el.changePct.textContent = `${quote.changePct >= 0 ? '+' : ''}${formatNumber(quote.changePct, 2)}%`;
      el.status.textContent = quote.status || '--';

      setTrendClass(el.change, quote.change);
      setTrendClass(el.changePct, quote.change);
    }

    function buildSimulatedSeries(basePrice, points = 120) {
      const safeBase = Number(basePrice) > 0 ? Number(basePrice) : 100;
      const arr = [];
      let p = safeBase;
      for (let i = 0; i < points; i += 1) {
        p += (Math.random() - 0.5) * safeBase * 0.0024;
        arr.push(Math.max(0.01, Number(p.toFixed(2))));
      }
      return arr;
    }

    function updateSeriesWithLatest(latest) {
      const safeLatest = Number(latest);
      if (!Number.isFinite(safeLatest) || safeLatest <= 0) return;
      if (!state.minuteSeries.length) {
        state.minuteSeries = buildSimulatedSeries(safeLatest);
        return;
      }
      state.minuteSeries.push(Number(safeLatest.toFixed(2)));
      if (state.minuteSeries.length > 180) {
        state.minuteSeries = state.minuteSeries.slice(-180);
      }
    }

    function drawChart() {
      const prices = state.minuteSeries;
      const dpr = window.devicePixelRatio || 1;
      const w = el.canvas.clientWidth;
      const h = el.canvas.clientHeight;
      el.canvas.width = Math.floor(w * dpr);
      el.canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      ctx.clearRect(0, 0, w, h);
      if (!prices.length) return;

      const min = Math.min(...prices);
      const max = Math.max(...prices);
      const pad = 18;
      const plotW = w - pad * 2;
      const plotH = h - pad * 2;
      const range = max - min || 1;

      ctx.strokeStyle = 'rgba(90,169,255,0.2)';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 4]);
      for (let i = 1; i <= 4; i += 1) {
        const y = pad + (plotH / 5) * i;
        ctx.beginPath();
        ctx.moveTo(pad, y);
        ctx.lineTo(pad + plotW, y);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      ctx.strokeStyle = '#5aa9ff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      prices.forEach((price, idx) => {
        const x = pad + (idx / Math.max(1, prices.length - 1)) * plotW;
        const y = pad + ((max - price) / range) * plotH;
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      const gradient = ctx.createLinearGradient(0, pad, 0, pad + plotH);
      gradient.addColorStop(0, 'rgba(90,169,255,0.35)');
      gradient.addColorStop(1, 'rgba(90,169,255,0.02)');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      prices.forEach((price, idx) => {
        const x = pad + (idx / Math.max(1, prices.length - 1)) * plotW;
        const y = pad + ((max - price) / range) * plotH;
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.lineTo(pad + plotW, pad + plotH);
      ctx.lineTo(pad, pad + plotH);
      ctx.closePath();
      ctx.fill();
    }

    function simulateQuote(symbol, nameHint = '模拟股票') {
      const previousClose = Number((20 + Math.random() * 200).toFixed(2));
      const latest = Number((previousClose * (1 + (Math.random() - 0.5) * 0.06)).toFixed(2));
      const open = Number((previousClose * (1 + (Math.random() - 0.5) * 0.02)).toFixed(2));
      const high = Number((Math.max(latest, open) * (1 + Math.random() * 0.02)).toFixed(2));
      const low = Number((Math.min(latest, open) * (1 - Math.random() * 0.02)).toFixed(2));
      const change = Number((latest - previousClose).toFixed(2));
      const changePct = Number(((change / previousClose) * 100).toFixed(2));

      return {
        symbol,
        name: nameHint,
        latest,
        open,
        high,
        low,
        volume: Math.round(5e6 + Math.random() * 2e8),
        amount: Math.round(5e7 + Math.random() * 5e9),
        change,
        changePct,
        status: '模拟数据',
        source: 'mock',
        timestamp: new Date().toISOString()
      };
    }

    async function fetchFromProxy(symbol) {
      let lastError = null;
      for (const endpoint of API_ENDPOINTS) {
        const controller = new AbortController();
        const timeoutId = window.setTimeout(() => controller.abort(), API_TIMEOUT_MS);
        try {
          const url = `${endpoint}?symbol=${encodeURIComponent(symbol)}`;
          const res = await fetch(url, {
            method: 'GET',
            cache: 'no-store',
            signal: controller.signal
          });
          if (!res.ok) {
            const errText = await res.text();
            throw new Error(`HTTP ${res.status}${errText ? `: ${errText.slice(0, 120)}` : ''}`);
          }
          const data = await res.json();
          if (!data || typeof data.latest !== 'number') {
            throw new Error('返回数据格式不正确');
          }
          data.source = data.source || (endpoint.startsWith('http') ? 'local_proxy_8787' : 'local_proxy');
          return data;
        } catch (err) {
          if (err && err.name === 'AbortError') {
            lastError = new Error(`请求超时（>${API_TIMEOUT_MS / 1000}秒）`);
          } else {
            lastError = err;
          }
        } finally {
          window.clearTimeout(timeoutId);
        }
      }
      throw lastError || new Error('本地代理不可用');
    }

    function fetchTencentJsonp(symbol) {
      return new Promise((resolve, reject) => {
        const normalized = (symbol || '').toLowerCase();
        const cbName = `__qt_cb_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
        const varName = `v_${normalized}`;
        const script = document.createElement('script');
        const timeoutId = window.setTimeout(() => {
          cleanup();
          reject(new Error('腾讯 JSONP 超时'));
        }, API_TIMEOUT_MS);

        function cleanup() {
          window.clearTimeout(timeoutId);
          if (script.parentNode) script.parentNode.removeChild(script);
          try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
          try { delete window[varName]; } catch (_) { window[varName] = undefined; }
        }

        window[cbName] = function () {
          try {
            const raw = window[varName];
            const body = String(raw || '').replace(/^\w+="|";?$/g, '');
            const p = body.split('~');
            if (p.length < 38) throw new Error('腾讯 JSONP 数据结构无效');

            const latest = Number(p[3]);
            const prevClose = Number(p[4]);
            const open = Number(p[5]);
            const high = Number(p[33]);
            const low = Number(p[34]);
            const volumeHand = Number(p[36]);
            const amountWan = Number(p[37]);
            const change = Number((latest - prevClose).toFixed(2));
            const changePct = prevClose ? Number((((latest - prevClose) / prevClose) * 100).toFixed(2)) : 0;

            resolve({
              symbol: normalized,
              name: p[1] || normalized,
              latest,
              open,
              high,
              low,
              volume: Math.round(volumeHand * 100),
              amount: Math.round(amountWan * 10000),
              change,
              changePct,
              status: '实时',
              source: 'tencent_jsonp',
              timestamp: new Date().toISOString()
            });
          } catch (e) {
            reject(e);
          } finally {
            cleanup();
          }
        };

        script.src = `https://qt.gtimg.cn/q=${normalized}&callback=${cbName}`;
        script.onerror = function () {
          cleanup();
          reject(new Error('腾讯 JSONP 加载失败'));
        };
        document.body.appendChild(script);
      });
    }

    async function loadQuote(symbol, reason = 'manual') {
      const rid = ++state.requestId;
      const active = WATCH_STOCKS.find((s) => s.code === symbol);
      const nameHint = active ? active.name : symbol;
      setError('');
      highlightWatch(symbol);

      if (reason !== 'auto') {
        setConnectionStatus('realtime', '加载中');
        el.status.textContent = '加载中...';
      }

      const mode = el.dataMode.value;

      if (mode === 'mock') {
        const q = simulateQuote(symbol, nameHint);
        if (rid !== state.requestId) return;
        renderQuote(q);
        updateSeriesWithLatest(q.latest);
        drawChart();
        updateTimeLabel();
        el.dataSource.textContent = '数据源：模拟数据（手动模式）';
        setConnectionStatus('degraded', '降级');
        return;
      }

      try {
        const q = await fetchFromProxy(symbol);
        if (rid !== state.requestId) return;
        renderQuote(q);
        updateSeriesWithLatest(q.latest);
        drawChart();
        updateTimeLabel();
        el.dataSource.textContent = `数据源：${q.source || '本地代理'}`;
        setConnectionStatus('realtime', '实时');
      } catch (err) {
        try {
          const q2 = await fetchTencentJsonp(symbol);
          if (rid !== state.requestId) return;
          renderQuote(q2);
          updateSeriesWithLatest(q2.latest);
          drawChart();
          updateTimeLabel();
          el.dataSource.textContent = '数据源：腾讯 JSONP（直连）';
          setConnectionStatus('realtime', '实时');
          setError(`本地代理不可用，已切换腾讯直连：${err.message}`);
        } catch (err2) {
          const fallback = simulateQuote(symbol, nameHint);
          if (rid !== state.requestId) return;
          renderQuote(fallback);
          updateSeriesWithLatest(fallback.latest);
          drawChart();
          updateTimeLabel();
          el.dataSource.textContent = '数据源：模拟数据（API失败自动降级）';
          setConnectionStatus('degraded', '降级');
          setError(`实时接口异常：${err.message} / ${err2.message}`);
        }
      }
    }

    function highlightWatch(symbol) {
      Array.from(el.watchList.children).forEach((node) => {
        node.classList.toggle('active', node.dataset.code === symbol);
      });
    }

    function renderWatchList() {
      el.watchList.innerHTML = '';
      WATCH_STOCKS.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'watch-item';
        row.dataset.code = item.code;
        row.innerHTML = `
          <div>
            <div>${item.code.toUpperCase()}</div>
            <div class="watch-name">${item.name}</div>
          </div>
          <div>查看</div>
        `;
        row.addEventListener('click', () => {
          state.currentSymbol = item.code;
          el.symbolInput.value = item.code;
          state.minuteSeries = [];
          loadQuote(item.code);
        });
        el.watchList.appendChild(row);
      });
      highlightWatch(state.currentSymbol);
    }

    function restartAutoRefresh() {
      if (state.refreshTimer) {
        window.clearInterval(state.refreshTimer);
        state.refreshTimer = null;
      }
      if (!el.autoRefresh.checked) return;
      const intervalSec = Number(el.refreshInterval.value) || 5;
      state.refreshTimer = window.setInterval(() => {
        loadQuote(state.currentSymbol, 'auto');
      }, intervalSec * 1000);
    }

    function onSearch() {
      const raw = el.symbolInput.value;
      if (!validateSymbol(raw)) {
        setConnectionStatus('error', '错误');
        setError('代码格式错误，请输入 sh600519 或 sz000001');
        return;
      }
      const symbol = normalizeSymbol(raw);
      state.currentSymbol = symbol;
      state.minuteSeries = [];
      loadQuote(symbol);
    }

    el.searchBtn.addEventListener('click', onSearch);
    el.symbolInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') onSearch();
    });

    el.refreshBtn.addEventListener('click', () => {
      loadQuote(state.currentSymbol);
    });

    el.dataMode.addEventListener('change', () => {
      loadQuote(state.currentSymbol);
    });

    el.autoRefresh.addEventListener('change', () => {
      restartAutoRefresh();
    });

    el.refreshInterval.addEventListener('change', () => {
      restartAutoRefresh();
    });

    window.addEventListener('resize', drawChart);

    renderWatchList();
    setConnectionStatus('realtime', '加载中');
    loadQuote(state.currentSymbol);
    restartAutoRefresh();
  </script>
</body>
</html>

      </div>
      
      
      
    </div>
    

    
    
    


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">自选股</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Bloodz Zhao</p>
  <div class="site-description" itemprop="description">心之所向，一路生辉</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bloodz Zhao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
